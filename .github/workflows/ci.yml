name: playwright Test Suite & Allure Report

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  execute-ui-tests:
    name: Run UI Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm ci

      - name: Run UI Tests (Playwright + Allure)
        env:
          MARKETSCALE_STAGING_URL: ${{ secrets.MARKETSCALE_STAGING_URL }}
        run: |
          npx playwright install --with-deps
          npx playwright test --reporter=line,allure-playwright

      - name: Upload UI Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: ui-allure-results
          path: allure-results
          retention-days: 7

  generate-allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [execute-ui-tests]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: ui-allure-results
          path: merged-allure-results

      - name: Generate Allure Report
        run: |
          npm install -g allure-commandline --no-save
          allure generate merged-allure-results --clean -o allure-report

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          retention-days: 7